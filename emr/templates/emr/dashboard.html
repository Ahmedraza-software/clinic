{% extends 'emr/base_emr.html' %}
{% load humanize %}
{% load static %}

{% block page_title %}EMR Dashboard{% endblock %}
{% block page_subtitle %}Welcome back, {{ request.user.get_full_name|default:request.user.username }}{% endblock %}

{% block emr_content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Patient Count Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Total Patients</h3>
                <p class="text-2xl font-semibold text-gray-900">{{ patient_count|intcomma }}</p>
            </div>
        </div>
    </div>
    
    <!-- Active Alerts Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Active Alerts</h3>
                <p class="text-2xl font-semibold text-gray-900">{{ active_alerts_count|intcomma }}</p>
            </div>
        </div>
    </div>
    
    <!-- Equipment Out Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Equipment Out</h3>
                <p class="text-2xl font-semibold text-gray-900">{{ equipment_out_count|intcomma }}</p>
            </div>
        </div>
    </div>
    
    <!-- Recent Forms Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Recent Forms (7d)</h3>
                <p class="text-2xl font-semibold text-gray-900">{{ recent_forms_count|intcomma }}</p>
            </div>
        </div>
    </div>
    
    <!-- OT Schedule Card -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Today's OT Schedule</h3>
                <p class="text-2xl font-semibold text-gray-900">{{ ot_schedule_count|default:"0" }} Surgeries</p>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Recent Patients -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Recent Patients</h3>
        </div>
        <div class="divide-y divide-gray-200">
            {% for patient in recent_patients %}
            <a href="{% url 'emr:patient_record' patient.id %}" class="block hover:bg-gray-50">
                <div class="px-6 py-4 flex items-center">
                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                        <span class="text-blue-600 font-medium">{{ patient.user.first_name|first|upper }}{{ patient.user.last_name|first|upper }}</span>
                    </div>
                    <div class="ml-4">
                        <h4 class="text-sm font-medium text-gray-900">{{ patient.user.get_full_name }}</h4>
                        <p class="text-sm text-gray-500">ID: {{ patient.id }}</p>
                    </div>
                    <div class="ml-auto text-sm text-gray-500">
                        {{ patient.created_at|date:"M d, Y" }}
                    </div>
                </div>
            </a>
            {% empty %}
            <div class="px-6 py-4 text-center text-gray-500">
                No recent patients found.
            </div>
            {% endfor %}
        </div>
        <div class="bg-gray-50 px-6 py-3 text-right">
            <a href="{% url 'patients:dashboard' %}" class="text-sm font-medium text-blue-600 hover:text-blue-500">
                View all patients
            </a>
        </div>
    </div>
    
    <!-- Recent Vital Signs -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Recent Vital Signs</h3>
        </div>
        <div class="divide-y divide-gray-200">
            {% for vital in recent_vitals %}
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-sm font-medium text-gray-900">{{ vital.patient.user.get_full_name }}</h4>
                        <div class="flex space-x-4 mt-1 text-xs text-gray-500">
                            {% if vital.temperature %}<span>üå°Ô∏è {{ vital.temperature }}¬∞C</span>{% endif %}
                            {% if vital.blood_pressure_systolic and vital.blood_pressure_diastolic %}
                                <span>üíì {{ vital.blood_pressure_systolic }}/{{ vital.blood_pressure_diastolic }} mmHg</span>
                            {% endif %}
                            {% if vital.heart_rate %}<span>‚ù§Ô∏è {{ vital.heart_rate }} bpm</span>{% endif %}
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">
                        {{ vital.recorded_at|timesince }} ago
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="px-6 py-4 text-center text-gray-500">
                No recent vital signs recorded.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Active Alerts -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">Active Alerts</h3>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                {{ active_alerts|length }} Active
            </span>
        </div>
        <div class="divide-y divide-gray-200">
            {% for alert in active_alerts %}
            <div class="px-6 py-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="h-6 w-6 rounded-full flex items-center justify-center bg-red-100 text-red-600">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </span>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-gray-900">
                                {{ alert.title }}
                            </p>
                            <div class="text-xs text-gray-500">
                                {{ alert.created_at|timesince }} ago
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">
                            {{ alert.message|truncatewords:15 }}
                        </p>
                        {% if alert.patient %}
                        <p class="mt-2 text-xs text-gray-500">
                            Patient: {{ alert.patient.user.get_full_name }}
                        </p>
                        {% endif %}
                        <div class="mt-2">
                            <a href="{% url 'emr:acknowledge_alert' alert.id %}" class="text-xs font-medium text-blue-600 hover:text-blue-500">
                                Acknowledge
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="px-6 py-4 text-center text-gray-500">
                No active alerts.
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Upcoming OT Schedule -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">Upcoming Surgeries</h3>
            <a href="#" class="text-sm font-medium text-blue-600 hover:text-blue-500">View All</a>
        </div>
        <div class="divide-y divide-gray-200">
            {% if upcoming_surgeries %}
                {% for surgery in upcoming_surgeries %}
                <div class="px-6 py-4 hover:bg-gray-50">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                            <span class="text-purple-600 font-medium">{{ surgery.patient.user.first_name|first|upper }}</span>
                        </div>
                        <div class="ml-4 flex-1">
                            <div class="flex items-center justify-between">
                                <h4 class="text-sm font-medium text-gray-900">{{ surgery.patient.user.get_full_name }}</h4>
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if surgery.status == 'scheduled' %}bg-blue-100 text-blue-800
                                    {% elif surgery.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                                    {% elif surgery.status == 'completed' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ surgery.get_status_display }}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">
                                <span class="font-medium">{{ surgery.surgery_type }}</span>
                            </p>
                            <div class="mt-1 text-xs text-gray-500">
                                <span>üïí {{ surgery.scheduled_date|date:"M d, Y" }} at {{ surgery.scheduled_time|time:"H:i" }}</span>
                                <span class="mx-1">‚Ä¢</span>
                                <span>üë®‚Äç‚öïÔ∏è Dr. {{ surgery.surgeon.user.get_short_name }}</span>
                            </div>
                            {% if surgery.notes %}
                            <p class="mt-1 text-xs text-gray-500 truncate">üìù {{ surgery.notes|truncatewords:10 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="px-6 py-4 text-center text-gray-500">
                    No upcoming surgeries scheduled.
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Equipment Out -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Equipment Checked Out</h3>
        </div>
        <div class="divide-y divide-gray-200">
            {% for checkout in checked_out_equipment %}
            <div class="px-6 py-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <span class="h-6 w-6 rounded-full flex items-center justify-center bg-yellow-100 text-yellow-600">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                        </span>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-gray-900">
                                {{ checkout.equipment.name }}
                                <span class="text-xs font-normal text-gray-500">({{ checkout.equipment.equipment_id }})</span>
                            </p>
                            <span class="text-xs px-2 py-1 rounded-full {% if checkout.is_overdue %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {% if checkout.is_overdue %}Overdue{% else %}Due {{ checkout.expected_return|date:"M d" }}{% endif %}
                            </span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">
                            Checked out by {{ checkout.checked_out_by.get_full_name }}
                        </p>
                        {% if checkout.patient %}
                        <p class="mt-1 text-xs text-gray-500">
                            Patient: {{ checkout.patient.user.get_full_name }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="px-6 py-4 text-center text-gray-500">
                No equipment is currently checked out.
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
