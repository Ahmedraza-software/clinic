{% extends 'base.html' %}
{% load humanize %}

{% block title %}Expense Tracking - ClinicMS{% endblock %}
{% block page_title %}{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div></div>
        <div class="flex space-x-3">
            <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center" onclick="openExpenseModal()">
                <i class="fas fa-plus mr-2"></i> Add Expense
            </button>
            <button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center" onclick="openGoogleSheetsModal()">
                <i class="fas fa-file-import mr-2"></i> Import Patients
            </button>
            <button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 flex items-center">
                <i class="fas fa-file-export mr-2"></i> Export
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <!-- Total Expenses -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-red-100 text-red-600">
                    <i class="fas fa-money-bill-wave text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Total Expenses</p>
                    <p class="text-2xl font-semibold text-gray-800">PKR <span class="countup" data-target="{{ total_expenses }}" data-decimals="0">{{ total_expenses|intcomma }}</span></p>
                    <p class="text-xs text-red-600 mt-1">
                        <i class="fas fa-arrow-up mr-1"></i> {{ expense_change }}% from last month
                    </p>
                </div>
            </div>
        </div>

        <!-- Expenses by Category -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-tags text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Categories</p>
                    <p class="text-2xl font-semibold text-gray-800">
                        <span class="countup" data-target="{{ categories_count }}" data-decimals="0">{{ categories_count }}</span>
                    </p>
                    <p class="text-xs text-gray-500 mt-1">Active expense categories</p>
                </div>
            </div>
        </div>

        <!-- Recurring Expenses -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-sync-alt text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Recurring</p>
                    <p class="text-2xl font-semibold text-gray-800">PKR <span class="countup" data-target="{{ recurring_expenses }}" data-decimals="0">{{ recurring_expenses|intcomma }}</span></p>
                    <p class="text-xs text-green-600 mt-1">Monthly recurring expenses</p>
                </div>
            </div>
        </div>

        <!-- Average Daily Spend -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-calendar-day text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Avg. Daily Spend</p>
                    <p class="text-2xl font-semibold text-gray-800">PKR <span class="countup" data-target="{{ avg_daily_spend }}" data-decimals="0">{{ avg_daily_spend|intcomma }}</span></p>
                    <p class="text-xs text-gray-500 mt-1">This month</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Expenses Over Time -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Expenses Over Time</h3>
                <select class="text-sm border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500">
                    <option>This Year</option>
                    <option>Last Year</option>
                    <option>Last 6 Months</option>
                    <option>Last 3 Months</option>
                    <option>This Month</option>
                </select>
            </div>
            <div class="h-64">
                <canvas id="expensesOverTimeChart"></canvas>
            </div>
        </div>

        <!-- Expenses by Category -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Expenses by Category</h3>
                <select class="text-sm border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500">
                    <option>This Month</option>
                    <option>Last Month</option>
                    <option>This Year</option>
                </select>
            </div>
            <div class="h-64">
                <canvas id="expensesByCategoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Expenses Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <h3 class="text-lg font-medium text-gray-900">Recent Expenses</h3>
                <!-- Upload Progress Counter -->
                <div id="uploadProgress" class="hidden flex items-center space-x-2 text-sm text-gray-600">
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-spinner fa-spin text-blue-500"></i>
                        <span>Processing: <span id="processedCount">0</span> / <span id="totalCount">0</span> records</span>
                    </div>
                    <div class="text-gray-400">|</div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-clock text-gray-400"></i>
                        <span>Est. time: <span id="estimatedTime">--</span></span>
                    </div>
                </div>
            </div>
            <div class="flex space-x-2">
                <input type="text" placeholder="Search expenses..." class="text-sm border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500" id="searchInput">
                <select class="text-sm border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500" id="categoryFilter">
                    <option value="">All Categories</option>
                    {% for category in expense_categories %}
                    <option value="{{ category.name }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Method</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for expense in recent_expenses %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ expense.expense_date|date:"M d, Y" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ expense.description }}</div>
                            <div class="text-sm text-gray-500">{{ expense.reference|default:"" }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-{{ expense.category.color }}-100 text-{{ expense.category.color }}-800">
                                {{ expense.category.name }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ expense.payment_method }}
                            {% if expense.recurring %}
                            <span class="ml-1 text-blue-500" title="Recurring"><i class="fas fa-sync-alt"></i></span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">
                            PKR {{ expense.amount|intcomma }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 mr-3 edit-expense-btn" data-expense-id="{{ expense.id }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-900 delete-expense-btn" data-expense-id="{{ expense.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                            No expenses found. Click "Add Expense" to get started.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Previous
                </a>
                <a href="#" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next
                </a>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing
                        <span class="font-medium">1</span>
                        to
                        <span class="font-medium">10</span>
                        of
                        <span class="font-medium">20</span>
                        results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        <a href="#" aria-current="page" class="z-10 bg-blue-50 border-blue-500 text-blue-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                            1
                        </a>
                        <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                            2
                        </a>
                        <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                            3
                        </a>
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                            ...
                        </span>
                        <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                            8
                        </a>
                        <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Expense Modal -->
<div class="fixed z-10 inset-0 overflow-y-auto hidden" id="expenseModal">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form method="post" id="expenseForm">
                {% csrf_token %}
                <input type="hidden" name="expense_id" id="expense_id" value="">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Add New Expense
                            </h3>
                            <div class="mt-5 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                                <div class="sm:col-span-6">
                                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                    <input type="text" name="description" id="description" required autocomplete="off" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>

                                <div class="sm:col-span-3">
                                    <label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                                    <div class="mt-1 relative rounded-md shadow-sm">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="text-gray-500 sm:text-sm">PKR</span>
                                        </div>
                                        <input type="number" step="0.01" name="amount" id="amount" required class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-md" placeholder="Amount">
                                    </div>
                                </div>

                                <div class="sm:col-span-3">
                                    <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                                    <input type="date" name="date" id="date" required class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>

                                <div class="sm:col-span-3">
                                    <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                                    <select id="category" name="category" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select a category</option>
                                        {% for category in expense_categories %}
                                        <option value="{{ category.name }}">{{ category.name }}</option>
                                        {% empty %}
                                        <option value="Office Supplies">Office Supplies</option>
                                        <option value="Utilities">Utilities</option>
                                        <option value="Salaries">Salaries</option>
                                        <option value="Rent">Rent</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Travel">Travel</option>
                                        <option value="Other">Other</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="sm:col-span-3">
                                    <label for="payment_method" class="block text-sm font-medium text-gray-700">Payment Method</label>
                                    <select id="payment_method" name="payment_method" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="cash">Cash</option>
                                        <option value="credit_card">Credit Card</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="check">Check</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="sm:col-span-6">
                                    <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                                    <div class="mt-1">
                                        <textarea id="notes" name="notes" rows="3" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md"></textarea>
                                    </div>
                                </div>

                                <div class="sm:col-span-6">
                                    <div class="flex items-start">
                                        <div class="flex items-center h-5">
                                            <input id="recurring" name="recurring" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                                        </div>
                                        <div class="ml-3 text-sm">
                                            <label for="recurring" class="font-medium text-gray-700">This is a recurring expense</label>
                                            <p class="text-gray-500">This expense will be automatically added each month.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Save Expense
                    </button>
                    <button type="button" onclick="closeExpenseModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="fixed z-20 inset-0 overflow-y-auto hidden" id="deleteConfirmModal">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="delete-modal-title">
                            Delete Expense
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" id="delete-modal-message">
                                Are you sure you want to delete this expense? This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmDeleteBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="fas fa-trash mr-2"></i>
                    Delete
                </button>
                <button type="button" onclick="closeDeleteModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Google Sheets Import Modal -->
<div class="fixed z-10 inset-0 overflow-y-auto hidden" id="googleSheetsModal">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="google-modal-title">
                            Import Patients from Google Sheets
                        </h3>
                        <div class="mt-5">
                            <!-- Instructions -->
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                                <h4 class="text-sm font-medium text-blue-800 mb-2">How to get your Google Sheets CSV ID:</h4>
                                <ol class="text-sm text-blue-700 list-decimal list-inside space-y-1">
                                    <li>Open your Google Sheet</li>
                                    <li>Go to File > Share > Publish to web</li>
                                    <li>Under "Link" tab, select "Comma-separated values (.csv)"</li>
                                    <li>Click "Publish" and copy the URL</li>
                                    <li>The ID is the part between "/d/" and "/export" in the URL</li>
                                </ol>
                            </div>
                            
                            <!-- Input Form -->
                            <div class="grid grid-cols-1 gap-y-4">
                                <div>
                                    <label for="sheetId" class="block text-sm font-medium text-gray-700">Google Sheets ID</label>
                                    <input type="text" name="sheetId" id="sheetId" required value="1fYUdK_cprGPj8UEoZVI38DiqI7P4G_loOXf8Xg62TWc" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                    <p class="mt-1 text-xs text-gray-500">Your Google Sheet ID is pre-filled</p>
                                </div>
                                
                                <div>
                                    <label for="sheetName" class="block text-sm font-medium text-gray-700">Sheet Name (Optional)</label>
                                    <input type="text" name="sheetName" id="sheetName" placeholder="Sheet1" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                    <p class="mt-1 text-xs text-gray-500">Leave blank for the first sheet</p>
                                </div>

                                <!-- Expected Columns Display -->
                                <div class="bg-gray-50 rounded-md p-3">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2">Expected CSV Columns:</h4>
                                    <div class="text-xs text-gray-600 grid grid-cols-2 gap-2">
                                        <div><strong>First Name:</strong> (text)</div>
                                        <div><strong>Last Name:</strong> (text)</div>
                                        <div><strong>Date of Birth:</strong> (MM/DD/YYYY)</div>
                                        <div><strong>Gender:</strong> (Male/Female/Other)</div>
                                        <div><strong>Email:</strong> (email address)</div>
                                        <div><strong>Phone:</strong> (phone number)</div>
                                        <div><strong>Address:</strong> (text, optional)</div>
                                        <div><strong>Blood Type:</strong> (A+/A-/B+/B-/O+/O-/AB+/AB-)</div>
                                        <div><strong>Emergency Contact:</strong> (text, optional)</div>
                                        <div><strong>Emergency Phone:</strong> (phone, optional)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="importFromGoogleSheets()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="fas fa-download mr-2"></i> Import Patients
                </button>
                <button type="button" onclick="closeGoogleSheetsModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chart data (safe JSON for JS parsing) -->
{{ chart_data|json_script:"chart-data" }}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Counter animation for summary metrics (runs independently)
    function formatNumber(value, decimals) {
        const opts = { minimumFractionDigits: decimals, maximumFractionDigits: decimals };
        return Number(value).toLocaleString('en-US', opts);
    }

    function animateCount(el, target, decimals = 0, duration = 1200) {
        const startTime = performance.now();
        const start = 0;
        function tick(now) {
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / duration, 1);
            // easeOutCubic
            const eased = 1 - Math.pow(1 - progress, 3);
            const current = start + (target - start) * eased;
            el.textContent = formatNumber(current, decimals);
            if (progress < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.countup').forEach((el) => {
            const target = parseFloat(el.getAttribute('data-target') || '0');
            const decimals = parseInt(el.getAttribute('data-decimals') || '0', 10);
            animateCount(el, target, decimals);
        });
    });

    // Get chart data from Django context safely
    let chartData = null;
    try {
        const chartEl = document.getElementById('chart-data');
        if (chartEl) {
            chartData = JSON.parse(chartEl.textContent);
        }
    } catch (e) {
        chartData = null;
    }

    // Expenses Over Time Chart (guarded)
    try {
        if (chartData && chartData.expenses_over_time) {
            const overTimeCanvas = document.getElementById('expensesOverTimeChart');
            if (overTimeCanvas) {
                const expensesOverTimeCtx = overTimeCanvas.getContext('2d');
                const expensesOverTimeChart = new Chart(expensesOverTimeCtx, {
                    type: 'line',
                    data: {
                        labels: chartData.expenses_over_time.labels,
                        datasets: [{
                            label: 'Expenses',
                            data: chartData.expenses_over_time.data,
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { drawBorder: false },
                                ticks: { callback: function(value){ return 'PKR ' + value.toLocaleString(); } }
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }
        }
    } catch (_) { /* no-op */ }

    // Expenses by Category Chart (guarded)
    try {
        if (chartData && chartData.expenses_by_category) {
            const byCatCanvas = document.getElementById('expensesByCategoryChart');
            if (byCatCanvas) {
                const expensesByCategoryCtx = byCatCanvas.getContext('2d');
                const expensesByCategoryChart = new Chart(expensesByCategoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: chartData.expenses_by_category.labels,
                        datasets: [{
                            data: chartData.expenses_by_category.data,
                            backgroundColor: chartData.expenses_by_category.colors,
                            borderWidth: 0,
                            offset: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { boxWidth: 12, padding: 15, usePointStyle: true, pointStyle: 'circle' }
                            }
                        },
                        cutout: '70%',
                        animation: { animateScale: true, animateRotate: true }
                    }
                });
            }
        }
    } catch (_) { /* no-op */ }

    

    // Modal functionality
    function openExpenseModal() {
        const modal = document.getElementById('expenseModal');
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    
    function closeExpenseModal() {
        const modal = document.getElementById('expenseModal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        document.getElementById('expenseForm').reset();
        document.getElementById('expense_id').value = '';
        document.getElementById('modal-title').textContent = 'Add New Expense';
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        const expenseModal = document.getElementById('expenseModal');
        const deleteModal = document.getElementById('deleteConfirmModal');
        const googleSheetsModal = document.getElementById('googleSheetsModal');
        
        if (e.target === expenseModal) {
            closeExpenseModal();
        }
        if (e.target === deleteModal) {
            closeDeleteModal();
        }
        if (e.target === googleSheetsModal) {
            closeGoogleSheetsModal();
        }
    });
    
    // Close modal with ESC key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (!document.getElementById('expenseModal').classList.contains('hidden')) {
                closeExpenseModal();
            }
            if (!document.getElementById('deleteConfirmModal').classList.contains('hidden')) {
                closeDeleteModal();
            }
            if (!document.getElementById('googleSheetsModal').classList.contains('hidden')) {
                closeGoogleSheetsModal();
            }
        }
    });
    
    // Add event listeners for edit and delete buttons
    document.addEventListener('click', (e) => {
        if (e.target.closest('.edit-expense-btn')) {
            const expenseId = e.target.closest('.edit-expense-btn').dataset.expenseId;
            editExpense(expenseId);
        }
        
        if (e.target.closest('.delete-expense-btn')) {
            const expenseId = e.target.closest('.delete-expense-btn').dataset.expenseId;
            deleteExpense(expenseId);
        }
    });
    
    // Edit expense function
    async function editExpense(expenseId) {
        try {
            const response = await fetch(`/finance/get-expense/${expenseId}/`);
            const expense = await response.json();
            
            if (expense.success) {
                // Populate form with expense data
                document.getElementById('expense_id').value = expense.data.id;
                document.getElementById('description').value = expense.data.description;
                document.getElementById('amount').value = expense.data.amount;
                document.getElementById('date').value = expense.data.expense_date;
                document.getElementById('category').value = expense.data.category;
                document.getElementById('payment_method').value = expense.data.payment_method;
                document.getElementById('notes').value = expense.data.notes || '';
                document.getElementById('recurring').checked = expense.data.is_recurring;
                
                // Update modal title
                document.getElementById('modal-title').textContent = 'Edit Expense';
                
                // Show modal
                document.getElementById('expenseModal').classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            } else {
                alert('Error loading expense data');
            }
        } catch (error) {
            alert('Error loading expense: ' + error.message);
        }
    }
    
    // Delete expense function
    function deleteExpense(expenseId) {
        // Store the expense ID for later use
        window.pendingDeleteExpenseId = expenseId;
        
        // Show custom delete confirmation modal
        document.getElementById('deleteConfirmModal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    
    // Close delete modal
    function closeDeleteModal() {
        document.getElementById('deleteConfirmModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        window.pendingDeleteExpenseId = null;
    }
    
    // Confirm delete expense
    async function confirmDeleteExpense() {
        const expenseId = window.pendingDeleteExpenseId;
        if (!expenseId) return;
        
        try {
            const response = await fetch(`/finance/delete-expense/${expenseId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            const result = await response.json();
            if (result.success) {
                closeDeleteModal();
                location.reload();
            } else {
                alert('Error deleting expense: ' + result.error);
            }
        } catch (error) {
            alert('Error deleting expense: ' + error.message);
        }
    }
    
    // Add event listener for confirm delete button
    document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeleteExpense);
    
    // Upload Progress and Time Estimation
    let uploadStartTime = null;
    let uploadTimer = null;
    
    function showUploadProgress(totalRecords, message = 'Processing') {
        uploadStartTime = Date.now();
        
        const totalElement = document.getElementById('totalCount');
        const processedElement = document.getElementById('processedCount');
        const progressElement = document.getElementById('uploadProgress');
        
        if (totalElement) {
            totalElement.textContent = totalRecords;
        }
        if (processedElement) {
            processedElement.textContent = '0';
        }
        if (progressElement) {
            progressElement.classList.remove('hidden');
        }
        
        // Update message if provided
        const progressText = document.querySelector('#uploadProgress span');
        if (progressText && message !== 'Processing') {
            progressText.textContent = `${message}: `;
        }
        
        // Start updating estimated time
        updateEstimatedTime();
    }
    
    function updateUploadProgress(processedRecords) {
        const processedElement = document.getElementById('processedCount');
        if (processedElement) {
            processedElement.textContent = processedRecords;
        }
    }
    
    function updateEstimatedTime() {
        if (!uploadStartTime) return;
        
        const processedElement = document.getElementById('processedCount');
        const totalElement = document.getElementById('totalCount');
        
        if (!processedElement || !totalElement) return;
        
        const elapsed = (Date.now() - uploadStartTime) / 1000; // seconds
        const processed = parseInt(processedElement.textContent) || 0;
        const total = parseInt(totalElement.textContent) || 0;
        
        if (processed > 0 && total > processed) {
            const rate = processed / elapsed; // records per second
            const remaining = total - processed;
            const estimatedSeconds = remaining / rate;
            
            let timeText;
            if (estimatedSeconds < 60) {
                timeText = `${Math.round(estimatedSeconds)}s`;
            } else if (estimatedSeconds < 3600) {
                timeText = `${Math.round(estimatedSeconds / 60)}m`;
            } else {
                timeText = `${Math.round(estimatedSeconds / 3600)}h`;
            }
            
            const estimatedTimeElement = document.getElementById('estimatedTime');
            if (estimatedTimeElement) {
                estimatedTimeElement.textContent = timeText;
            }
        }
        
        // Continue updating if not complete
        if (processed < total) {
            uploadTimer = setTimeout(updateEstimatedTime, 500);
        }
    }
    
    function hideUploadProgress() {
        document.getElementById('uploadProgress').classList.add('hidden');
        if (uploadTimer) {
            clearTimeout(uploadTimer);
            uploadTimer = null;
        }
        uploadStartTime = null;
    }
    
    // Simulate upload progress for demo purposes
    function simulateExpenseUpload(recordCount = 50) {
        showUploadProgress(recordCount);
        
        let processed = 0;
        const interval = setInterval(() => {
            processed += Math.floor(Math.random() * 5) + 1; // Process 1-5 records at a time
            if (processed > recordCount) processed = recordCount;
            
            updateUploadProgress(processed);
            
            if (processed >= recordCount) {
                clearInterval(interval);
                setTimeout(hideUploadProgress, 1000);
            }
        }, 200);
    }
    
    // Search and filter functionality
    function filterExpenses() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const rows = document.querySelectorAll('tbody tr');
        
        // Show progress for large datasets
        if (rows.length > 100) {
            showUploadProgress(rows.length);
        }
        
        let processed = 0;
        rows.forEach(row => {
            if (row.cells.length < 2) return; // Skip empty state row
            
            const description = row.cells[1].textContent.toLowerCase();
            const category = row.cells[2].textContent.trim();
            
            const matchesSearch = description.includes(searchTerm);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            if (matchesSearch && matchesCategory) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
            
            processed++;
            if (rows.length > 100) {
                updateUploadProgress(processed);
            }
        });
        
        if (rows.length > 100) {
            setTimeout(hideUploadProgress, 500);
        }
    }
    
    // Add event listeners for search and filter
    document.getElementById('searchInput').addEventListener('input', filterExpenses);
    document.getElementById('categoryFilter').addEventListener('change', filterExpenses);
    
    // Google Sheets Import Functions
    function openGoogleSheetsModal() {
        const modal = document.getElementById('googleSheetsModal');
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    
    function closeGoogleSheetsModal() {
        const modal = document.getElementById('googleSheetsModal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        document.getElementById('sheetId').value = '';
        document.getElementById('sheetName').value = '';
    }
    
    async function importFromGoogleSheets() {
        const sheetId = document.getElementById('sheetId').value.trim();
        const sheetName = document.getElementById('sheetName').value.trim() || 'Sheet1';
        
        if (!sheetId) {
            alert('Please enter a Google Sheets ID');
            return;
        }
        
        // Construct the CSV export URL
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
        
        try {
            // Show progress
            showUploadProgress(0, 'Fetching patient data from Google Sheets...');
            
            // Fetch CSV data
            const response = await fetch(csvUrl);
            if (!response.ok) {
                throw new Error(`Failed to fetch: ${response.status} ${response.statusText}`);
            }
            
            const csvText = await response.text();
            
            // Parse CSV
            const patients = parsePatientCSV(csvText);
            
            if (patients.length === 0) {
                throw new Error('No valid patients found in the CSV file');
            }
            
            // Update progress for processing
            showUploadProgress(patients.length, 'Processing patients...');
            
            // Process and display patients
            await processAndDisplayPatients(patients);
            
            // Hide modal and progress
            closeGoogleSheetsModal();
            setTimeout(hideUploadProgress, 1000);
            
            // Show success message
            showNotification(`Successfully imported ${patients.length} patients!`, 'success');
            
        } catch (error) {
            hideUploadProgress();
            alert('Error importing from Google Sheets: ' + error.message);
        }
    }
    
    function parsePatientCSV(csvText) {
        const lines = csvText.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            return []; // No data rows
        }
        
        // Parse headers (first row)
        const headers = parseCSVLine(lines[0]);
        
        // Parse data rows
        const patients = [];
        for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            if (values.length >= 6) { // Minimum required columns
                const patient = {
                    first_name: values[0] || '',
                    last_name: values[1] || '',
                    date_of_birth: values[2] || '',
                    gender: values[3] || '',
                    email: values[4] || '',
                    phone: values[5] || '',
                    address: values[6] || '',
                    blood_type: values[7] || '',
                    emergency_contact: values[8] || '',
                    emergency_phone: values[9] || ''
                };
                
                // Validate and clean data
                if (patient.first_name && patient.last_name && patient.email) {
                    patients.push(patient);
                }
            }
        }
        
        return patients;
    }
    
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current.trim());
        return result;
    }
    
    async function processAndDisplayPatients(patients) {
        // Find the correct expenses table tbody
        const tbody = document.querySelector('table tbody');
        
        if (!tbody) {
            throw new Error('Could not find the expenses table to display patients');
        }
        
        // Clear existing rows (except empty state)
        const existingRows = tbody.querySelectorAll('tr:not(:last-child)');
        existingRows.forEach(row => row.remove());
        
        // Process each patient
        for (let i = 0; i < patients.length; i++) {
            const patient = patients[i];
            
            // Create new row
            const row = createPatientRow(patient, i + 1);
            tbody.insertBefore(row, tbody.lastElementChild);
            
            // Update progress
            updateUploadProgress(i + 1);
            
            // Small delay for visual effect
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        // Hide empty state if we have data
        const emptyState = tbody.querySelector('tr:last-child');
        if (patients.length > 0 && emptyState && emptyState.cells.length === 6) {
            emptyState.style.display = 'none';
        }
    }
    
    function createPatientRow(patient, index) {
        const row = document.createElement('tr');
        
        // Calculate age from date of birth
        const age = calculateAge(patient.date_of_birth);
        
        // Get gender color
        const genderColors = {
            'Male': 'blue',
            'Female': 'pink',
            'Other': 'purple'
        };
        const genderColor = genderColors[patient.gender] || 'gray';
        
        // Get blood type badge color
        const bloodTypeColors = {
            'A+': 'red', 'A-': 'red',
            'B+': 'blue', 'B-': 'blue', 
            'O+': 'green', 'O-': 'green',
            'AB+': 'purple', 'AB-': 'purple'
        };
        const bloodTypeColor = bloodTypeColors[patient.blood_type] || 'gray';
        
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="h-10 w-10 flex-shrink-0">
                        <div class="h-10 w-10 rounded-full bg-${genderColor}-100 flex items-center justify-center">
                            <span class="text-sm font-medium text-${genderColor}-800">
                                ${patient.first_name.charAt(0)}${patient.last_name.charAt(0)}
                            </span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">${patient.first_name} ${patient.last_name}</div>
                        <div class="text-sm text-gray-500">${patient.email}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${age} years</div>
                <div class="text-sm text-gray-500">${formatDate(patient.date_of_birth)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${genderColor}-100 text-${genderColor}-800">
                    ${patient.gender}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${patient.phone}</div>
                <div class="text-sm text-gray-500">${patient.address || 'No address'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${bloodTypeColor}-100 text-${bloodTypeColor}-800">
                    ${patient.blood_type || 'Unknown'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <span class="text-green-600">
                    <i class="fas fa-check-circle"></i> Imported
                </span>
            </td>
        `;
        
        return row;
    }
    
    function calculateAge(dateOfBirth) {
        if (!dateOfBirth) return 'Unknown';
        
        const today = new Date();
        const birthDate = new Date(dateOfBirth);
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        
        return age;
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'Unknown';
        
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg transform transition-all duration-300 ${
            type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
            type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
            'bg-blue-100 text-blue-800 border border-blue-200'
        }`;
        
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle text-green-600' :
                    type === 'error' ? 'fa-exclamation-circle text-red-600' :
                    'fa-info-circle text-blue-600'
                } mr-2"></i>
                <span class="text-sm font-medium">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // Auto-import patients from Google Sheets on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Automatically import patients after a short delay
        setTimeout(() => {
            autoImportPatients();
        }, 1000);
    });
    
    async function autoImportPatients() {
        const sheetId = '1fYUdK_cprGPj8UEoZVI38DiqI7P4G_loOXf8Xg62TWc';
        const sheetName = 'Sheet1'; // Default to first sheet
        
        // Construct the CSV export URL
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
        
        try {
            // Show progress
            showUploadProgress(0, 'Auto-fetching patient data from Google Sheets...');
            
            // Fetch CSV data
            const response = await fetch(csvUrl);
            if (!response.ok) {
                throw new Error(`Failed to fetch: ${response.status} ${response.statusText}`);
            }
            
            const csvText = await response.text();
            
            // Parse CSV
            const patients = parsePatientCSV(csvText);
            
            if (patients.length === 0) {
                throw new Error('No valid patients found in the Google Sheet');
            }
            
            // Update progress for processing
            showUploadProgress(patients.length, 'Processing patients...');
            
            // Process and display patients
            await processAndDisplayPatients(patients);
            
            // Hide progress after completion
            setTimeout(hideUploadProgress, 2000);
            
            // Show success message
            showNotification(`Successfully imported ${patients.length} patients from Google Sheets!`, 'success');
            
        } catch (error) {
            hideUploadProgress();
            showNotification('Error auto-importing patients: ' + error.message, 'error');
            console.error('Auto-import error:', error);
        }
    }
</script>
{% endblock %}
{% endblock %}

