{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Create Appointment - Clinic Management{% endblock %}
{% block page_title %}{% endblock %}

{% block extra_css %}
<style>
    .form-field {
        transition: all 0.3s ease;
    }
    .form-field:focus-within {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    .appointment-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .field-icon {
        transition: color 0.3s ease;
    }
    .form-field:focus-within .field-icon {
        color: #3b82f6;
    }
    .select-field, .input-field, .textarea-field {
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 12px;
        transition: all 0.3s ease;
        background-color: #fafafa;
    }
    .select-field:focus, .input-field:focus, .textarea-field:focus {
        outline: none;
        border-color: #3b82f6;
        background-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .progress-step {
        transition: all 0.3s ease;
    }
    .progress-step.active {
        background-color: #3b82f6;
        color: white;
    }
    .progress-step.completed {
        background-color: #10b981;
        color: white;
    }
    /* Ultra compact layout */
    .compact-form {
        min-height: 60vh;
    }
    .field-group {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
    }
    .field-label {
        font-size: 11px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
    }
    .field-help {
        font-size: 10px;
        color: #6b7280;
        margin-top: 2px;
    }
    /* Patient dropdown styling */
    .patient-item:hover {
        background-color: #eff6ff;
        border-left: 3px solid #3b82f6;
    }
    .patient-item {
        transition: all 0.2s ease;
    }
    #patientDropdown {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border: 1px solid #d1d5db;
    }
    #patientSearch:focus + #patientDropdown {
        border-color: #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-blue-50 to-indigo-100 py-2">
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Ultra Compact Header -->
        <div class="appointment-card rounded-lg shadow-md p-2 mb-2 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-base font-bold mb-0">Create New Appointment</h1>
                    <p class="text-blue-100 text-xs">Schedule a new appointment for your patient</p>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-full p-1">
                    <i class="fas fa-calendar-plus text-xs"></i>
                </div>
            </div>
        </div>

        <!-- Ultra Compact Progress Steps -->
        <div class="bg-white rounded-md shadow-sm p-1 mb-2">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-1">
                    <div class="progress-step active w-5 h-5 rounded-full flex items-center justify-center text-xs font-semibold">
                        1
                    </div>
                    <span class="text-xs font-medium text-gray-700">Patient & Doctor</span>
                </div>
                <div class="flex-1 h-px bg-gray-200 mx-1"></div>
                <div class="flex items-center space-x-1">
                    <div class="progress-step w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center text-xs font-semibold text-gray-500">
                        2
                    </div>
                    <span class="text-xs font-medium text-gray-500">Date & Time</span>
                </div>
                <div class="flex-1 h-px bg-gray-200 mx-1"></div>
                <div class="flex items-center space-x-1">
                    <div class="progress-step w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center text-xs font-semibold text-gray-500">
                        3
                    </div>
                    <span class="text-xs font-medium text-gray-500">Details</span>
                </div>
            </div>
        </div>

        <!-- Ultra Compact Form Card -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden compact-form">
            <!-- Compact Navigation Bar -->
            <div class="bg-gray-50 px-2 py-1 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-stethoscope text-blue-600 text-xs"></i>
                        <span class="text-xs font-medium text-gray-700">Appointment Details</span>
                    </div>
                    <a href="{% url 'appointments:list' %}" 
                       class="inline-flex items-center px-2 py-1 text-xs font-medium text-gray-600 bg-white border border-gray-300 rounded-sm hover:bg-gray-50 hover:text-gray-700 transition-colors duration-200">
                        <i class="fas fa-arrow-left mr-1 text-xs"></i>
                        Back
                    </a>
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
                <div class="px-2 py-1">
                    {% for message in messages %}
                        <div class="mb-1 p-1 rounded {% if message.tags == 'error' %}bg-red-50 border-l-2 border-red-400 text-red-700{% else %}bg-green-50 border-l-2 border-green-400 text-green-700{% endif %}">
                            <div class="flex items-center">
                                <i class="fas {% if message.tags == 'error' %}fa-exclamation-triangle{% else %}fa-check-circle{% endif %} mr-1 text-xs"></i>
                                <p class="text-xs font-medium">{{ message }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Ultra Wide Horizontal Form -->
            <form method="post" class="p-3" id="appointmentForm" data-patients='[
                {% for patient in all_patients %}
                {
                    "id": {{ patient.id }},
                    "name": "{{ patient.user.get_full_name|default:patient.user.username|escapejs }}",
                    "email": "{{ patient.user.email|escapejs }}",
                    "phone": "{{ patient.phone|default:''|escapejs }}",
                    "age": "{{ patient.age|default:''|escapejs }}",
                    "gender": "{{ patient.gender|default:''|escapejs }}",
                    "bloodType": "{{ patient.blood_type|default:''|escapejs }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]'>
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="bg-red-50 border-l-4 border-red-400 p-2 rounded-lg mb-3">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>
                            <p class="text-xs text-red-700 font-medium">{{ form.non_field_errors|join:", " }}</p>
                        </div>
                    </div>
                {% endif %}

                <!-- All Fields in One Compact Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                    
                    <!-- Patient -->
                    <div class="field-group">
                        <div class="flex items-center space-x-1 mb-1">
                            <i class="fas fa-user text-blue-600 text-xs"></i>
                            <span class="field-label">PATIENT</span>
                        </div>
                        <div class="relative">
                            <!-- Hidden actual form field -->
                            {{ form.patient|add_class:"hidden" }}
                            <!-- Custom searchable input -->
                            <input 
                                type="text" 
                                id="patientSearch" 
                                class="input-field w-full text-xs" 
                                placeholder="Type patient name..."
                                autocomplete="off"
                            >
                            <div id="patientDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto hidden">
                                <!-- Patient results will be populated here -->
                            </div>
                        </div>
                        {% if form.patient.errors %}
                            <p class="mt-1 text-xs text-red-600">{{ form.patient.errors|join:", " }}</p>
                        {% endif %}
                        <p class="field-help">Search and select patient</p>
                    </div>

                    <!-- Doctor -->
                    <div class="field-group">
                        <div class="flex items-center space-x-1 mb-1">
                            <i class="fas fa-user-md text-green-600 text-xs"></i>
                            <span class="field-label">DOCTOR</span>
                        </div>
                        <div class="relative">
                            {{ form.doctor|add_class:"select-field w-full text-xs" }}
                            <div class="absolute inset-y-0 right-0 flex items-center pr-1 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                            </div>
                        </div>
                        {% if form.doctor.errors %}
                            <p class="mt-1 text-xs text-red-600">{{ form.doctor.errors|join:", " }}</p>
                        {% endif %}
                        <p class="field-help">Choose doctor</p>
                    </div>

                    <!-- Date -->
                    <div class="field-group">
                        <div class="flex items-center space-x-1 mb-1">
                            <i class="fas fa-calendar-day text-purple-600 text-xs"></i>
                            <span class="field-label">DATE</span>
                        </div>
                        {{ form.appointment_date|add_class:"input-field w-full text-xs" }}
                        {% if form.appointment_date.errors %}
                            <p class="mt-1 text-xs text-red-600">{{ form.appointment_date.errors|join:", " }}</p>
                        {% endif %}
                        <p class="field-help">Appointment date</p>
                    </div>

                    <!-- Time -->
                    <div class="field-group">
                        <div class="flex items-center space-x-1 mb-1">
                            <i class="fas fa-clock text-orange-600 text-xs"></i>
                            <span class="field-label">TIME</span>
                        </div>
                        {{ form.appointment_time|add_class:"input-field w-full text-xs" }}
                        {% if form.appointment_time.errors %}
                            <p class="mt-1 text-xs text-red-600">{{ form.appointment_time.errors|join:", " }}</p>
                        {% endif %}
                        <p class="field-help">Appointment time</p>
                    </div>

                    <!-- Type -->
                    <div class="field-group">
                        <div class="flex items-center space-x-1 mb-1">
                            <i class="fas fa-tag text-indigo-600 text-xs"></i>
                            <span class="field-label">TYPE</span>
                        </div>
                        <div class="relative">
                            {{ form.appointment_type|add_class:"select-field w-full text-xs" }}
                            <div class="absolute inset-y-0 right-0 flex items-center pr-1 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                            </div>
                        </div>
                        {% if form.appointment_type.errors %}
                            <p class="mt-1 text-xs text-red-600">{{ form.appointment_type.errors|join:", " }}</p>
                        {% endif %}
                        <p class="field-help">Appointment type</p>
                    </div>
                </div>

                <!-- Second Row for Additional Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                    
                    <!-- Status -->
                    <div class="field-group">
                        <div class="flex items-center space-x-1 mb-1">
                            <i class="fas fa-flag text-yellow-600 text-xs"></i>
                            <span class="field-label">STATUS</span>
                        </div>
                        <div class="relative">
                            {{ form.status|add_class:"select-field w-full text-xs" }}
                            <div class="absolute inset-y-0 right-0 flex items-center pr-1 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                            </div>
                        </div>
                        {% if form.status.errors %}
                            <p class="mt-1 text-xs text-red-600">{{ form.status.errors|join:", " }}</p>
                        {% endif %}
                        <p class="field-help">Current status</p>
                    </div>

                    <!-- Notes -->
                    <div class="field-group">
                        <div class="flex items-center space-x-1 mb-1">
                            <i class="fas fa-sticky-note text-pink-600 text-xs"></i>
                            <span class="field-label">NOTES</span>
                        </div>
                        {{ form.notes|add_class:"textarea-field w-full resize-none h-12 text-xs" }}
                        {% if form.notes.errors %}
                            <p class="mt-1 text-xs text-red-600">{{ form.notes.errors|join:", " }}</p>
                        {% endif %}
                        <p class="field-help">Additional notes (optional)</p>
                    </div>
                </div>

                <!-- Compact Action Buttons -->
                <div class="flex justify-end space-x-2 mt-4 pt-3 border-t border-gray-200">
                    <a href="{% url 'appointments:list' %}" 
                       class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-lg text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 transition-colors duration-200">
                        <i class="fas fa-times mr-1"></i>
                        Cancel
                    </a>
                    <button type="submit" 
                            class="inline-flex items-center px-4 py-1 text-xs font-medium rounded-lg text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 transition-all duration-200">
                        <i class="fas fa-plus mr-1"></i>
                        Create Appointment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Patient Modal -->
<div class="fixed z-50 inset-0 overflow-y-auto hidden" id="newPatientModal">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="newPatientForm">
                {% csrf_token %}
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="new-patient-modal-title">
                                Add New Patient
                            </h3>
                            <div class="mt-5 grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-6">
                                <!-- First Name -->
                                <div class="sm:col-span-3">
                                    <label for="first_name" class="block text-sm font-medium text-gray-700">First Name <span class="text-red-500">*</span></label>
                                    <input type="text" name="first_name" id="first_name" required class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                
                                <!-- Last Name -->
                                <div class="sm:col-span-3">
                                    <label for="last_name" class="block text-sm font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label>
                                    <input type="text" name="last_name" id="last_name" required class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                
                                <!-- Email -->
                                <div class="sm:col-span-3">
                                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" name="email" id="email" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                
                                <!-- Phone -->
                                <div class="sm:col-span-3">
                                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone <span class="text-red-500">*</span></label>
                                    <input type="tel" name="phone" id="phone" required class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                
                                <!-- Date of Birth -->
                                <div class="sm:col-span-3">
                                    <label for="date_of_birth" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                                    <input type="date" name="date_of_birth" id="date_of_birth" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                
                                <!-- Gender -->
                                <div class="sm:col-span-3">
                                    <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                                    <select id="gender" name="gender" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <!-- Address -->
                                <div class="sm:col-span-6">
                                    <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                                    <textarea id="address" name="address" rows="2" class="mt-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md"></textarea>
                                </div>
                                
                                <!-- Blood Type -->
                                <div class="sm:col-span-3">
                                    <label for="blood_type" class="block text-sm font-medium text-gray-700">Blood Group</label>
                                    <select id="blood_type" name="blood_type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="">Select Blood Group</option>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="O+">O+</option>
                                        <option value="O-">O-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Payment Information -->
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="text-sm font-medium text-gray-900 mb-4">Payment Information</h4>
                                <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-6">
                                    <!-- Registration Fee -->
                                    <div class="sm:col-span-3">
                                        <label for="registration_fee" class="block text-sm font-medium text-gray-700">Registration Fee</label>
                                        <div class="mt-1 relative rounded-md shadow-sm">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <span class="text-gray-500 sm:text-sm">PKR</span>
                                            </div>
                                            <input type="number" step="0.01" name="registration_fee" id="registration_fee" class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-12 pr-12 sm:text-sm border-gray-300 rounded-md" placeholder="0.00">
                                        </div>
                                    </div>
                                    
                                    <!-- Payment Method -->
                                    <div class="sm:col-span-3">
                                        <label for="payment_method" class="block text-sm font-medium text-gray-700">Payment Method</label>
                                        <select id="payment_method" name="payment_method" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                            <option value="">Select Payment Method</option>
                                            <option value="cash">Cash</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="insurance">Insurance</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Payment Notes -->
                                    <div class="sm:col-span-6">
                                        <label for="payment_notes" class="block text-sm font-medium text-gray-700">Payment Notes</label>
                                        <textarea id="payment_notes" name="payment_notes" rows="2" class="mt-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md" placeholder="Additional payment information or notes"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Account Information -->
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="text-sm font-medium text-gray-900 mb-4">Account Information</h4>
                                <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-6">
                                    <!-- Password -->
                                    <div class="sm:col-span-3">
                                        <label for="password1" class="block text-sm font-medium text-gray-700">Password</label>
                                        <input type="password" name="password1" id="password1" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="At least 8 characters">
                                    </div>
                                    
                                    <!-- Confirm Password -->
                                    <div class="sm:col-span-3">
                                        <label for="password2" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                                        <input type="password" name="password2" id="password2" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Confirm password">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-user-plus mr-2"></i>
                        Add Patient
                    </button>
                    <button type="button" onclick="closeNewPatientModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Patient data from database - read from HTML data attribute to avoid linting issues
const patients = JSON.parse(document.getElementById('appointmentForm').getAttribute('data-patients'));

document.addEventListener('DOMContentLoaded', function() {
    // Add form validation and interactivity
    const form = document.getElementById('appointmentForm');
    const progressSteps = document.querySelectorAll('.progress-step');
    
    // Patient search functionality
    const patientSearch = document.getElementById('patientSearch');
    const patientDropdown = document.getElementById('patientDropdown');
    const patientField = document.querySelector('select[name="patient"]');
    let selectedPatient = null;
    let highlightedIndex = -1;
    
    // Search patients
    patientSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        highlightedIndex = -1;
        
        if (query.length < 2) {
            patientDropdown.classList.add('hidden');
            return;
        }
        
        const filteredPatients = patients.filter(patient => 
            patient.name.toLowerCase().includes(query) ||
            patient.email.toLowerCase().includes(query) ||
            patient.phone.includes(query) ||
            patient.id.toString().includes(query)
        );
        
        if (filteredPatients.length === 0) {
            patientDropdown.innerHTML = `
                <div class="p-3 text-center">
                    <p class="text-xs text-gray-500 mb-2">No patients found</p>
                    <button type="button" onclick="openNewPatientModal()" class="w-full px-3 py-2 bg-green-600 text-white text-xs font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <i class="fas fa-user-plus mr-1"></i>
                        Add New Patient
                    </button>
                </div>
            `;
        } else {
            patientDropdown.innerHTML = filteredPatients.map((patient, index) => `
                <div class="patient-item px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" data-patient-id="${patient.id}" data-index="${index}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold text-xs text-gray-800">${patient.name}</div>
                            <div class="text-xs text-gray-500">ID: ${patient.id} | ${patient.email}</div>
                            ${patient.phone ? `<div class="text-xs text-gray-400">${patient.phone}</div>` : ''}
                        </div>
                        <div class="text-right">
                            ${patient.age ? `<div class="text-xs text-gray-600">${patient.age}y</div>` : ''}
                            ${patient.gender ? `<div class="text-xs text-gray-600">${patient.gender}</div>` : ''}
                            ${patient.bloodType ? `<div class="text-xs font-semibold text-red-600">${patient.bloodType}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add click handlers to patient items
            document.querySelectorAll('.patient-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectPatient(this.dataset.patientId);
                });
            });
        }
        
        patientDropdown.classList.remove('hidden');
    });
    
    // Function to select a patient
    function selectPatient(patientId) {
        const patient = patients.find(p => p.id == patientId);
        
        if (patient) {
            selectedPatient = patient;
            patientSearch.value = patient.name;
            patientField.value = patientId;
            patientDropdown.classList.add('hidden');
            highlightedIndex = -1;
            
            // Update progress
            updateProgress();
        }
    }
    
    // Keyboard navigation
    patientSearch.addEventListener('keydown', function(e) {
        const items = document.querySelectorAll('.patient-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
            updateHighlight(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            highlightedIndex = Math.max(highlightedIndex - 1, 0);
            updateHighlight(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (highlightedIndex >= 0 && items[highlightedIndex]) {
                selectPatient(items[highlightedIndex].dataset.patientId);
            }
        } else if (e.key === 'Escape') {
            patientDropdown.classList.add('hidden');
            highlightedIndex = -1;
        }
    });
    
    // Function to update highlight
    function updateHighlight(items) {
        items.forEach((item, index) => {
            if (index === highlightedIndex) {
                item.classList.add('bg-blue-50', 'border-left-3', 'border-blue-500');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('bg-blue-50', 'border-left-3', 'border-blue-500');
            }
        });
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!patientSearch.contains(e.target) && !patientDropdown.contains(e.target)) {
            patientDropdown.classList.add('hidden');
        }
    });
    
    // Clear selection if input is cleared
    patientSearch.addEventListener('blur', function() {
        if (!this.value.trim()) {
            selectedPatient = null;
            patientField.value = '';
        }
    });
    
    // Update progress based on form completion
    function updateProgress() {
        const patientValue = patientField.value;
        const doctorField = document.querySelector('select[name="doctor"]');
        const dateField = document.querySelector('input[name="appointment_date"]');
        const timeField = document.querySelector('input[name="appointment_time"]');
        
        // Step 1: Patient & Doctor
        if (patientValue && doctorField.value) {
            progressSteps[0].classList.add('completed');
            progressSteps[0].classList.remove('active');
            progressSteps[1].classList.add('active');
        } else {
            progressSteps[0].classList.add('active');
            progressSteps[0].classList.remove('completed');
            progressSteps[1].classList.remove('active');
        }
        
        // Step 2: Date & Time
        if (dateField.value && timeField.value) {
            progressSteps[1].classList.add('completed');
            progressSteps[1].classList.remove('active');
            progressSteps[2].classList.add('active');
        } else if (patientValue && doctorField.value) {
            progressSteps[1].classList.add('active');
            progressSteps[1].classList.remove('completed');
            progressSteps[2].classList.remove('active');
        }
    }
    
    // Add event listeners for form fields
    const formFields = form.querySelectorAll('select, input');
    formFields.forEach(field => {
        field.addEventListener('change', updateProgress);
        field.addEventListener('input', updateProgress);
    });
    
    // Add smooth animations for form fields
    const fieldGroups = document.querySelectorAll('.field-group');
    fieldGroups.forEach(container => {
        const input = container.querySelector('select, input, textarea');
        if (input) {
            input.addEventListener('focus', () => {
                container.style.transform = 'translateY(-1px)';
                container.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
            });
            
            input.addEventListener('blur', () => {
                container.style.transform = 'translateY(0)';
                container.style.boxShadow = 'none';
            });
        }
    });
    
    // New Patient Modal Functions
    function openNewPatientModal() {
        document.getElementById('newPatientModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        patientDropdown.classList.add('hidden');
    }

    function closeNewPatientModal() {
        document.getElementById('newPatientModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('newPatientForm').reset();
    }

    // Handle new patient form submission
    document.getElementById('newPatientForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/api/patients/create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new patient to the patients array
                const newPatient = {
                    id: data.patient.id,
                    name: `${data.patient.first_name} ${data.patient.last_name}`,
                    email: data.patient.email,
                    phone: data.patient.phone,
                    age: data.patient.age,
                    gender: data.patient.gender,
                    bloodType: data.patient.blood_type
                };
                patients.push(newPatient);
                
                // Select the new patient
                selectPatient(newPatient.id);
                
                // Close modal
                closeNewPatientModal();
                
                // Show success message
                showNotification('Patient added successfully!', 'success');
            } else {
                showNotification('Error adding patient: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error adding patient:', error);
            showNotification('Error adding patient. Please try again.', 'error');
        });
    });

    // Simple notification function
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg transform transition-all duration-300 ${
            type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                <span class="text-sm font-medium">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
});
</script>
{% endblock %}
