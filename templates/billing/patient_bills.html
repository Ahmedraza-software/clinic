{% extends 'base.html' %}
{% load humanize %}

{% block title %}Patient Billing - Clinic Management System{% endblock %}

{% block extra_css %}
<style>
    @keyframes slideInTop {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .slide-in-row {
        opacity: 0;
        animation: slideInTop 0.4s ease-out forwards;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-area flex-1 flex flex-col overflow-hidden">
    <!-- Page Content -->
    <main class="flex-1 overflow-y-auto bg-gray-50">
        <div class="py-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold text-gray-800">Patient Billing</h2>
    <div class="flex space-x-3">
        <button onclick="openNewBillModal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center">
            <i class="fas fa-plus mr-2"></i> New Bill
        </button>
        <a href="{% url 'export_patient_bills' %}" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 flex items-center text-gray-700 hover:text-gray-900 no-underline">
            <i class="fas fa-download mr-2"></i> Export
        </a>
    </div>
</div>


<!-- Billing Summary -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <i class="fas fa-file-invoice-dollar text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Total Bills</p>
                <p class="text-2xl font-semibold text-gray-800"><span class="countup" data-target="{{ summary.total_bills|default:0 }}" data-decimals="0">{{ summary.total_bills|intcomma }}</span></p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
                <i class="fas fa-check-circle text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Paid</p>
                <p class="text-2xl font-semibold text-gray-800">$<span class="countup" data-target="{{ summary.total_paid|default:0 }}" data-decimals="0">{{ summary.total_paid|intcomma }}</span></p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                <i class="fas fa-clock text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Pending</p>
                <p class="text-2xl font-semibold text-gray-800">$<span class="countup" data-target="{{ summary.total_pending|default:0 }}" data-decimals="0">{{ summary.total_pending|intcomma }}</span></p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-600">
                <i class="fas fa-exclamation-triangle text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Overdue</p>
                <p class="text-2xl font-semibold text-gray-800">$<span class="countup" data-target="{{ summary.total_overdue|default:0 }}" data-decimals="0">{{ summary.total_overdue|intcomma }}</span></p>
            </div>
        </div>
    </div>
</div>

<!-- Billing Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <div>
            <h3 class="text-lg font-medium text-gray-900">Recent Bills</h3>
            {% if search_query %}
            <p class="text-sm text-gray-600 mt-1">
                <i class="fas fa-search mr-1"></i>
                Search results for "<span class="font-medium">{{ search_query }}</span>"
                <button onclick="clearSearch()" class="ml-2 text-blue-600 hover:text-blue-800 underline">Clear</button>
            </p>
            {% endif %}
        </div>
        <div class="flex items-center space-x-2">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search bills..." value="{{ search_query }}" 
                       class="pl-10 pr-10 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                {% if search_query %}
                <button onclick="clearSearch()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600" title="Clear search">
                    <i class="fas fa-times"></i>
                </button>
                {% endif %}
            </div>
            <button class="p-2 text-gray-500 hover:text-gray-700">
                <i class="fas fa-filter"></i>
            </button>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment #</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="relative px-3 py-2">
                        <span class="sr-only">Actions</span>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for bill in bills %}
                <tr class="hover:bg-gray-50 slide-in-row" style="animation-delay: {{ forloop.counter0|add:1 }}0ms;">
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="text-xs font-medium text-blue-600">#{{ bill.bill_number }}</div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-6 w-6">
                                <i class="fas fa-user-circle text-lg text-gray-400"></i>
                            </div>
                            <div class="ml-2">
                                <button class="text-left hover:bg-blue-50 p-1 rounded transition-colors patient-payment-btn" 
                                    data-patient-id="{{ bill.patient.id }}" 
                                    data-patient-name="{{ bill.patient.user.get_full_name }}">
                                    <div class="text-xs font-medium text-blue-600 hover:text-blue-800 cursor-pointer">{{ bill.patient.user.get_full_name }}</div>
                                    <div class="text-xs text-gray-500">ID: {{ bill.patient.id }}</div>
                                </button>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="text-xs text-gray-900">{{ bill.payment_type }}</div>
                        {% if bill.notes %}
                        <div class="text-xs text-gray-500 max-w-24 truncate">{{ bill.notes }}</div>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="text-xs text-gray-900">{{ bill.bill_date|date:"M d, Y" }}</div>
                        <div class="text-xs text-gray-500">{{ bill.bill_date|date:"g:i A" }}</div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="flex items-center">
                            {% if bill.payment_method == 'Cash' %}
                                <i class="fas fa-money-bill-alt text-green-600 mr-1 text-xs"></i>
                            {% elif bill.payment_method == 'Credit/Debit Card' %}
                                <i class="fas fa-credit-card text-blue-600 mr-1 text-xs"></i>
                            {% elif bill.payment_method == 'Bank Transfer' %}
                                <i class="fas fa-university text-purple-600 mr-1 text-xs"></i>
                            {% elif bill.payment_method == 'Insurance' %}
                                <i class="fas fa-shield-alt text-orange-600 mr-1 text-xs"></i>
                            {% else %}
                                <i class="fas fa-receipt text-gray-600 mr-1 text-xs"></i>
                            {% endif %}
                            <span class="text-xs text-gray-900">{{ bill.payment_method }}</span>
                        </div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <div class="text-xs font-semibold text-gray-900">${{ bill.total_amount|floatformat:2|intcomma }}</div>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        {% if bill.status == 'paid' %}
                            <span class="px-1 inline-flex text-xs leading-4 font-semibold rounded bg-green-100 text-green-800">
                                <i class="fas fa-check text-xs mr-1"></i>
                                Paid
                            </span>
                        {% elif bill.status == 'unpaid' %}
                            <span class="px-1 inline-flex text-xs leading-4 font-semibold rounded bg-red-100 text-red-800">
                                <i class="fas fa-times text-xs mr-1"></i>
                                Unpaid
                            </span>
                        {% elif bill.status == 'partially_paid' %}
                            <span class="px-1 inline-flex text-xs leading-4 font-semibold rounded bg-yellow-100 text-yellow-800">
                                <i class="fas fa-clock text-xs mr-1"></i>
                                Partial
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-xs font-medium">
                        <div class="flex justify-end space-x-1">
                            <button class="text-blue-600 hover:text-blue-900 p-1" title="View Details">
                                <i class="fas fa-eye text-xs"></i>
                            </button>
                            <button class="text-green-600 hover:text-green-900 p-1" title="Print Receipt">
                                <i class="fas fa-print text-xs"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="px-3 py-4 text-center text-xs text-gray-500">
                        <div class="py-4">
                            <i class="fas fa-receipt text-2xl text-gray-300 mb-2"></i>
                            <p>No payments found.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
        <div class="flex-1 flex justify-between sm:hidden">
            <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Previous
            </a>
            <a href="#" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Next
            </a>
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-gray-700">
                    Showing <span class="font-medium">{{ page_obj.start_index }}</span> to <span class="font-medium">{{ page_obj.end_index }}</span> of <span class="font-medium">{{ page_obj.paginator.count }}</span> results
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">First</span>
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Previous</span>
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 text-sm font-medium text-blue-600">
                                {{ num }}
                            </a>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                {{ num }}
                            </a>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Next</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Last</span>
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>
                </div>
            </div>
        </div>
    </main>
</div>


<!-- New Bill Modal -->
<div id="newBillModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pb-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-file-invoice text-blue-600 mr-2"></i>
                    Create New Bill
                </h3>
                <button onclick="closeNewBillModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <form id="newBillForm" method="POST" action="{% url 'create_bill' %}">
                {% csrf_token %}
                <div class="mt-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Patient</label>
                        <select name="patient_id" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                            <option value="">Loading patients...</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select the patient to create a bill for</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <select name="description_select" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm mb-2" onchange="updateDescription(this)">
                            <option value="">Select common service or enter custom</option>
                            <option value="Consultation Fee">Consultation Fee</option>
                            <option value="Lab Test">Lab Test</option>
                            <option value="X-Ray">X-Ray</option>
                            <option value="Ultrasound">Ultrasound</option>
                            <option value="Blood Test">Blood Test</option>
                            <option value="Prescription">Prescription</option>
                            <option value="Follow-up Visit">Follow-up Visit</option>
                            <option value="Procedure Fee">Procedure Fee</option>
                            <option value="Surgery Fee">Surgery Fee</option>
                            <option value="Emergency Visit">Emergency Visit</option>
                            <option value="custom">Custom Description</option>
                        </select>
                        <input type="text" name="description" required placeholder="Enter custom description..."
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                        <input type="number" name="amount" step="0.01" min="0" required placeholder="0.00"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="date" name="due_date" required
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                        <textarea name="notes" rows="3" placeholder="Additional notes..."
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 mt-6">
                    <button type="button" onclick="closeNewBillModal()" 
                        class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                        Create Bill
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Patient Payments Modal -->
<div id="patientPaymentsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pb-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-user-circle text-blue-600 mr-2"></i>
                    <span id="modalPatientName">Patient</span> - Payment History
                </h3>
                <button onclick="closePatientPaymentsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="mt-4">
                <!-- Summary -->
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div class="p-4 bg-green-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-green-800">Total Paid</span>
                            <span class="text-xl font-bold text-green-900" id="modalTotalPaid">$0</span>
                        </div>
                        <p class="text-xs text-green-600 mt-1">All time payments</p>
                    </div>
                    <div class="p-4 bg-red-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-red-800">Total Due</span>
                            <span class="text-xl font-bold text-red-900" id="modalTotalDue">$0</span>
                        </div>
                        <p class="text-xs text-red-600 mt-1">Outstanding balance</p>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="paymentsLoading" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                    <p class="text-gray-500 mt-2">Loading payment details...</p>
                </div>
                
                <!-- Payments List -->
                <div id="paymentsListContainer" class="hidden">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Payment Details</h4>
                    <div class="max-h-96 overflow-y-auto">
                        <div id="paymentsListContent">
                            <!-- Payments will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="paymentsEmpty" class="hidden text-center py-8">
                    <i class="fas fa-receipt text-4xl text-gray-300"></i>
                    <p class="text-gray-500 mt-2">No payments found for this patient</p>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex justify-end pt-4 border-t border-gray-200 mt-6">
                <button onclick="closePatientPaymentsModal()" 
                    class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Pay Bill Modal -->
<div id="payBillModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pb-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-credit-card text-green-600 mr-2"></i>
                    Pay Bill
                </h3>
                <button onclick="closePayBillModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <form id="payBillForm" method="POST">
                {% csrf_token %}
                <div class="mt-4 space-y-4">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm font-medium text-gray-700">Bill: <span id="payBillNumber" class="text-blue-600"></span></p>
                        <p class="text-sm text-gray-600">Amount Due: <span id="payAmountDue" class="font-semibold text-red-600"></span></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Amount</label>
                        <input type="number" name="payment_amount" step="0.01" min="0" required placeholder="0.00"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Enter amount to pay (can be partial)</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                        <select name="payment_method" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select Payment Method</option>
                            <option value="cash">Cash</option>
                            <option value="card">Credit/Debit Card</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="insurance">Insurance</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                        <textarea name="payment_notes" rows="3" placeholder="Payment notes..."
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 mt-6">
                    <button type="button" onclick="closePayBillModal()" 
                        class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                        class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 transition-colors">
                        Process Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Add event listeners for patient payment buttons
document.addEventListener('DOMContentLoaded', function() {
    const patientButtons = document.querySelectorAll('.patient-payment-btn');
    patientButtons.forEach(button => {
        button.addEventListener('click', function() {
            const patientId = this.getAttribute('data-patient-id');
            const patientName = this.getAttribute('data-patient-name');
            openPatientPaymentsModal(patientId, patientName);
        });
    });
});

function openPatientPaymentsModal(patientId, patientName) {
    document.getElementById('patientPaymentsModal').classList.remove('hidden');
    document.getElementById('modalPatientName').textContent = patientName;
    document.body.style.overflow = 'hidden';
    loadPatientPayments(patientId);
}

function closePatientPaymentsModal() {
    document.getElementById('patientPaymentsModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function loadPatientPayments(patientId) {
    // Show loading state
    document.getElementById('paymentsLoading').classList.remove('hidden');
    document.getElementById('paymentsListContainer').classList.add('hidden');
    document.getElementById('paymentsEmpty').classList.add('hidden');
    
    // Fetch patient payments
    fetch(`/billing/patient-payments/${patientId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('paymentsLoading').classList.add('hidden');
            
            if (data.records && data.records.length > 0) {
                displayPatientRecords(data.records, data.total_paid, data.total_due);
                document.getElementById('paymentsListContainer').classList.remove('hidden');
            } else {
                document.getElementById('paymentsEmpty').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading patient payments:', error);
            document.getElementById('paymentsLoading').classList.add('hidden');
            document.getElementById('paymentsEmpty').classList.remove('hidden');
        });
}

function displayPatientRecords(records, totalPaid, totalDue) {
    document.getElementById('modalTotalPaid').textContent = '$' + parseFloat(totalPaid).toLocaleString();
    document.getElementById('modalTotalDue').textContent = '$' + parseFloat(totalDue).toLocaleString();
    
    const container = document.getElementById('paymentsListContent');
    container.innerHTML = '';
    
    records.forEach(record => {
        const recordDiv = document.createElement('div');
        recordDiv.className = 'border border-gray-200 rounded-lg p-4 mb-3 hover:bg-gray-50';
        
        const typeColor = record.type === 'payment' ? getPaymentTypeColor(record.payment_type) : 'bg-blue-100 text-blue-600';
        const methodIcon = record.type === 'payment' ? getPaymentMethodIcon(record.payment_method) : '<i class="fas fa-file-invoice text-lg"></i>';
        
        let statusBadge = '';
        let actionButtons = '';
        
        if (record.status === 'paid') {
            statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Paid</span>';
        } else if (record.status === 'unpaid') {
            statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-times-circle mr-1"></i>Unpaid</span>';
            actionButtons = `<button onclick="openPayBillModal('${record.id}', '${record.bill_number}', '${record.remaining_amount}')" class="mt-2 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"><i class="fas fa-credit-card mr-1"></i>Pay Bill</button>`;
        } else if (record.status === 'partially_paid') {
            statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i>Partial</span>';
            actionButtons = `<button onclick="openPayBillModal('${record.id}', '${record.bill_number}', '${record.remaining_amount}')" class="mt-2 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"><i class="fas fa-credit-card mr-1"></i>Pay Remaining</button>`;
        }
        
        let amountDisplay = '';
        if (record.type === 'bill' && record.status !== 'paid') {
            amountDisplay = `
                <div class="text-right">
                    <div class="text-lg font-bold text-gray-900">$${parseFloat(record.amount).toFixed(2)}</div>
                    <div class="text-sm text-gray-600">Paid: $${parseFloat(record.paid_amount).toFixed(2)}</div>
                    <div class="text-sm font-medium text-red-600">Due: $${parseFloat(record.remaining_amount).toFixed(2)}</div>
                </div>
            `;
        } else {
            amountDisplay = `<div class="text-lg font-bold text-gray-900">$${parseFloat(record.amount).toFixed(2)}</div>`;
        }
        
        recordDiv.innerHTML = `
            <div class="flex items-start justify-between">
                <div class="flex items-start flex-1">
                    <div class="flex-shrink-0 w-12 h-12 ${typeColor} rounded-full flex items-center justify-center mr-4">
                        ${methodIcon}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="text-sm font-semibold text-gray-900">${record.bill_number}</h5>
                            ${amountDisplay}
                        </div>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-700">
                                <span class="font-medium">Type:</span> ${record.payment_type_display}
                            </p>
                            ${record.type === 'payment' ? `<p class="text-sm text-gray-700"><span class="font-medium">Method:</span> ${record.payment_method_display}</p>` : ''}
                            <p class="text-sm text-gray-700">
                                <span class="font-medium">Date:</span> ${record.date}
                            </p>
                            ${record.due_date && record.status !== 'paid' ? `<p class="text-sm text-gray-700"><span class="font-medium">Due Date:</span> ${record.due_date}</p>` : ''}
                            ${record.is_overdue ? `<p class="text-sm text-red-600"><span class="font-medium">Overdue:</span> ${record.days_overdue} days</p>` : ''}
                            ${record.notes ? `<p class="text-sm text-gray-600"><span class="font-medium">Notes:</span> ${record.notes}</p>` : ''}
                        </div>
                        <div class="mt-2 flex items-center justify-between">
                            ${statusBadge}
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(recordDiv);
    });
}

function getPaymentTypeColor(paymentType) {
    const colors = {
        'registration': 'bg-blue-100 text-blue-600',
        'consultation': 'bg-green-100 text-green-600',
        'procedure': 'bg-purple-100 text-purple-600',
        'medication': 'bg-orange-100 text-orange-600',
        'discharge': 'bg-red-100 text-red-600',
        'other': 'bg-gray-100 text-gray-600'
    };
    return colors[paymentType] || colors['other'];
}

function getPaymentMethodIcon(paymentMethod) {
    const icons = {
        'cash': '<i class="fas fa-money-bill-alt text-lg"></i>',
        'card': '<i class="fas fa-credit-card text-lg"></i>',
        'bank_transfer': '<i class="fas fa-university text-lg"></i>',
        'insurance': '<i class="fas fa-shield-alt text-lg"></i>'
    };
    return icons[paymentMethod] || '<i class="fas fa-receipt text-lg"></i>';
}

// Close modal when clicking outside
document.getElementById('patientPaymentsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePatientPaymentsModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('patientPaymentsModal').classList.contains('hidden')) {
        closePatientPaymentsModal();
    }
    if (e.key === 'Escape' && !document.getElementById('newBillModal').classList.contains('hidden')) {
        closeNewBillModal();
    }
});

// New Bill Modal Functions
function openNewBillModal() {
    document.getElementById('newBillModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadPatients();
    
    // Set default due date to 30 days from now
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    document.querySelector('input[name="due_date"]').value = dueDate.toISOString().split('T')[0];
}

function closeNewBillModal() {
    document.getElementById('newBillModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('newBillForm').reset();
}

function loadPatients() {
    fetch('/billing/get-patients/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const select = document.querySelector('select[name="patient_id"]');
            select.innerHTML = '<option value="">Select Patient</option>';
            
            if (data.patients && data.patients.length > 0) {
                data.patients.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.id;
                    // Show name, ID, and status
                    const statusText = patient.status === 'discharged' ? ' (Discharged)' : 
                                     patient.status === 'inactive' ? ' (Inactive)' : '';
                    option.textContent = `${patient.name} - ID: ${patient.id}${statusText}`;
                    select.appendChild(option);
                });
                console.log(`Loaded ${data.patients.length} patients`);
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No patients found';
                option.disabled = true;
                select.appendChild(option);
            }
        })
        .catch(error => {
            console.error('Error loading patients:', error);
            const select = document.querySelector('select[name="patient_id"]');
            select.innerHTML = '<option value="">Error loading patients</option>';
        });
}

// Handle description selection
function updateDescription(select) {
    const descriptionInput = document.querySelector('input[name="description"]');
    if (select.value && select.value !== 'custom') {
        descriptionInput.value = select.value;
        descriptionInput.readOnly = true;
        descriptionInput.classList.add('bg-gray-50');
    } else {
        descriptionInput.value = '';
        descriptionInput.readOnly = false;
        descriptionInput.classList.remove('bg-gray-50');
        if (select.value === 'custom') {
            descriptionInput.focus();
        }
    }
}

// Pay Bill Modal Functions
let currentBillId = null;

function openPayBillModal(recordId, billNumber, amountDue) {
    currentBillId = recordId.replace('bill_', ''); // Remove 'bill_' prefix
    document.getElementById('payBillNumber').textContent = billNumber;
    document.getElementById('payAmountDue').textContent = '$' + parseFloat(amountDue).toFixed(2);
    
    // Set max amount and default to full amount
    const amountInput = document.querySelector('input[name="payment_amount"]');
    amountInput.max = amountDue;
    amountInput.value = amountDue;
    
    // Set form action
    document.getElementById('payBillForm').action = `/billing/pay-bill/${currentBillId}/`;
    
    document.getElementById('payBillModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closePayBillModal() {
    document.getElementById('payBillModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('payBillForm').reset();
    currentBillId = null;
}

// Handle pay bill form submission
document.getElementById('payBillForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const paymentAmount = parseFloat(formData.get('payment_amount'));
    const maxAmount = parseFloat(document.querySelector('input[name="payment_amount"]').max);
    
    if (paymentAmount > maxAmount) {
        alert('Payment amount cannot exceed the amount due.');
        return;
    }
    
    if (paymentAmount <= 0) {
        alert('Payment amount must be greater than 0.');
        return;
    }
    
    // Submit the form
    this.submit();
});

// Close modals when clicking outside
document.getElementById('newBillModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeNewBillModal();
    }
});

document.getElementById('payBillModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePayBillModal();
    }
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (!document.getElementById('patientPaymentsModal').classList.contains('hidden')) {
            closePatientPaymentsModal();
        }
        if (!document.getElementById('newBillModal').classList.contains('hidden')) {
            closeNewBillModal();
        }
        if (!document.getElementById('payBillModal').classList.contains('hidden')) {
            closePayBillModal();
        }
    }
});

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    
    // Handle search input with debouncing
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            performSearch();
        }, 500); // Wait 500ms after user stops typing
    });
    
    // Handle Enter key press for immediate search
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            performSearch();
        }
    });
    
    function performSearch() {
        const searchQuery = searchInput.value.trim();
        const currentUrl = new URL(window.location);
        
        if (searchQuery) {
            currentUrl.searchParams.set('search', searchQuery);
        } else {
            currentUrl.searchParams.delete('search');
        }
        
        // Reset to first page when searching
        currentUrl.searchParams.delete('page');
        
        // Navigate to the new URL
        window.location.href = currentUrl.toString();
    }
});

// Clear search function
function clearSearch() {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.delete('search');
    currentUrl.searchParams.delete('page');
    window.location.href = currentUrl.toString();
}

// Counter animation for billing summary metrics
function formatNumber(value, decimals) {
    const opts = { minimumFractionDigits: decimals, maximumFractionDigits: decimals };
    return Number(value).toLocaleString('en-US', opts);
}

function animateCount(el, target, decimals = 0, duration = 1200) {
    const startTime = performance.now();
    const start = 0;
    function tick(now) {
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        // easeOutCubic
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = start + (target - start) * eased;
        el.textContent = formatNumber(current, decimals);
        if (progress < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
}

// Initialize counter animations on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting billing counter animations...');
    const counters = document.querySelectorAll('.countup');
    console.log('Found billing counters:', counters.length);
    counters.forEach((el, index) => {
        const target = parseFloat(el.getAttribute('data-target') || '0');
        const decimals = parseInt(el.getAttribute('data-decimals') || '0', 10);
        console.log(`Billing counter ${index}: target=${target}, decimals=${decimals}`);
        animateCount(el, target, decimals);
    });
});
</script>

{% endblock %}
